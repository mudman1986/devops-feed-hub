name: Weekly Refactor

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  create-refactor-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create Copilot-assigned refactor issue via GraphQL
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_PAT }}
          script: |
            // Step 1: Get repo ID, Copilot bot ID, and refactor label ID
            const repoInfo = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  id
                  suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                    nodes { login __typename ... on Bot { id } ... on User { id } }
                  }
                  label(name: "refactor") {
                    id
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const repoId = repoInfo.repository.id;
            const copilotBot = repoInfo.repository.suggestedActors.nodes.find(
              n => n.login === "copilot-swe-agent" && n.__typename === "Bot"
            );
            if (!copilotBot) {
              console.log("Actors found:");
              repoInfo.repository.suggestedActors.nodes.forEach(n => console.log(JSON.stringify(n)));
              throw new Error("Copilot bot agent not found in suggestedActors");
            }
            const copilotBotId = copilotBot.id;

            if (!repoInfo.repository.label) {
              throw new Error("refactor label not found in repository");
            }
            const refactorLabelId = repoInfo.repository.label.id;

            // Step 2: Create and assign issue to Copilot
            const res = await github.graphql(`
              mutation($repositoryId: ID!, $title: String!, $body: String!, $assigneeIds: [ID!]) {
                createIssue(
                  input: {
                    repositoryId: $repositoryId,
                    title: $title,
                    body: $body,
                    assigneeIds: $assigneeIds
                  }
                ) {
                  issue {
                    id
                    url
                    title
                    assignees(first: 10) { nodes { login } }
                  }
                }
              }
            `, {
              repositoryId: repoId,
              title: `Weekly Refactor - ${new Date().toISOString()}`,
              body: [
                'Review the codebase and make improvements:',
                '',
                '- Fix failing tests (superlinter, ci, ui tests)',
                '- Refactor duplicate code',
                '- Address security vulnerabilities',
                '- Improve code maintainability and performance',
                '- Enhance UI accessibility',
                '- Increase test coverage',
                '',
                '**Rules:**',
                '- Assign tasks to all available specialized agents in the repository (e.g., UI/UX Specialist, Test Runner, Code Review, etc.)',
                '- Make minimal surgical changes, run all linters/tests before completing.'
              ].join('\n'),
              assigneeIds: [copilotBotId]
            });

            console.log(`Created Copilot-assigned issue: ${res.createIssue.issue.url}`);

            // Step 3: Add refactor label to the issue
            const issueId = res.createIssue.issue.id;
            await github.graphql(`
              mutation($issueId: ID!, $labelIds: [ID!]!) {
                addLabelsToLabelable(
                  input: {
                    labelableId: $issueId,
                    labelIds: $labelIds
                  }
                ) {
                  labelable {
                    ... on Issue {
                      labels(first: 10) {
                        nodes {
                          name
                        }
                      }
                    }
                  }
                }
              }
            `, {
              issueId,
              labelIds: [refactorLabelId]
            });

            console.log(`Added 'refactor' label to issue`);
