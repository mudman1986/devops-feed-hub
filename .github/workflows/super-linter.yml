name: Superlinter

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: write
  statuses: write

jobs:
  super-lint:
    name: Lint Code Base
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Super-Linter
        uses: super-linter/super-linter@d5b0a2ab116623730dd094f15ddc1b6b25bf7b99 # v8.3.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: true
          IGNORE_GENERATED_FILES: true
          IGNORE_GITIGNORED_FILES: true
          SAVE_SUPER_LINTER_SUMMARY: true
          # Enable only useful, non-duplicate linters
          # When specific VALIDATE_* are set to true, only those linters run
          # Shell
          VALIDATE_BASH: true
          VALIDATE_BASH_EXEC: true
          VALIDATE_SHELL_SHFMT: true
          # Python
          VALIDATE_PYTHON_BLACK: true
          VALIDATE_PYTHON_ISORT: true
          VALIDATE_PYTHON_PYLINT: true
          VALIDATE_PYTHON_FLAKE8: true
          VALIDATE_PYTHON_MYPY: true
          # JavaScript/TypeScript
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_JAVASCRIPT_PRETTIER: true
          VALIDATE_TYPESCRIPT_ES: true
          VALIDATE_TYPESCRIPT_PRETTIER: true
          # CSS/HTML
          VALIDATE_CSS: true
          VALIDATE_CSS_PRETTIER: true
          VALIDATE_HTML: true
          VALIDATE_HTML_PRETTIER: true
          # JSON/YAML
          VALIDATE_JSON: true
          VALIDATE_JSON_PRETTIER: true
          VALIDATE_YAML: true
          VALIDATE_YAML_PRETTIER: true
          # Markdown
          VALIDATE_MARKDOWN: true
          VALIDATE_MARKDOWN_PRETTIER: true
          VALIDATE_NATURAL_LANGUAGE: true
          # GitHub Actions
          VALIDATE_GITHUB_ACTIONS: true
          # Security/Quality
          VALIDATE_GITLEAKS: true
          VALIDATE_GIT_MERGE_CONFLICT_MARKERS: true
          # Enable autofix for supported linters
          FIX_PYTHON_BLACK: true
          FIX_PYTHON_ISORT: true
          FIX_SHELL_SHFMT: true
          FIX_MARKDOWN_PRETTIER: true
          FIX_YAML_PRETTIER: true
          FIX_JAVASCRIPT_PRETTIER: true
          FIX_CSS_PRETTIER: true
          FIX_HTML_PRETTIER: true
          FIX_NATURAL_LANGUAGE: true

      - name: Commit and Push Autofix Changes
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email \
            "github-actions[bot]@users.noreply.github.com"

          # For PRs, checkout the actual branch to avoid detached HEAD
          if [ -n "${{ github.event.pull_request.head.ref }}" ]; then
            git checkout -B "${{ github.event.pull_request.head.ref }}"
          fi

          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "style: apply super-linter autofix"

            # Push to the appropriate branch
            if [ -n "${{ github.event.pull_request.head.ref }}" ]; then
              # For PRs, push to the PR branch with lease for safety
              if ! git push --force-with-lease origin \
                "HEAD:${{ github.event.pull_request.head.ref }}"; then
                echo "::warning::Failed to push autofix changes to PR"
                exit 1
              fi
            else
              # For direct pushes to main, push to current branch
              if ! git push origin HEAD:${GITHUB_REF#refs/heads/}; then
                echo "::warning::Failed to push autofix changes"
                exit 1
              fi
            fi
          else
            echo "No autofix changes to commit"
          fi
