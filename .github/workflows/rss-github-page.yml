name: RSS News Dashboard

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - ".github/workflows/**"
      - "tests/**"
      - "docs/**"

  schedule:
    - cron: "0 9 * * 1-5"

  workflow_dispatch:
    inputs:
      target-branch:
        description: "Target branch for GitHub Pages content (default: github-pages)"
        required: false
        default: "github-pages"

permissions:
  contents: write

concurrency:
  group: rss-feed-collection
  cancel-in-progress: false

jobs:
  collect-feeds:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Collect RSS Feeds
        id: collect
        uses: ./.github/actions/collect-rss-feeds
        with:
          hours: "720"
          config-path: ".github/rss-feeds.json"
          output-path: "rss-feeds-output.json"

      - name: Upload results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rss-feeds-${{ github.run_id }}
          path: rss-feeds-output.json
          retention-days: 30

      - name: Display collection stats
        if: always()
        run: |
          echo "## Collection Statistics"
          echo "- Total articles: ${{ steps.collect.outputs.total-articles }}"
          echo "- Successful feeds: ${{ steps.collect.outputs.successful-feeds }}"
          echo "- Failed feeds: ${{ steps.collect.outputs.failed-feeds }}"

      - name: Generate GitHub Pages content
        if: success()
        run: |
          # Create docs directory if it doesn't exist
          mkdir -p docs

          # Generate multi-page HTML (main index + individual feed pages)
          python3 .github/actions/collect-rss-feeds/generate_summary.py \
            --input rss-feeds-output.json \
            --output-dir docs

          echo "✓ GitHub Pages content generated (multi-page)"

      - name: Format HTML files
        if: success()
        run: |
          npx prettier --write docs/*.html
          echo "✓ HTML files formatted with Prettier"

      - name: Commit and push GitHub Pages content
        if: success()
        run: |
          # Default to 'github-pages' branch, override with workflow_dispatch input if provided
          TARGET_BRANCH="github-pages"
          if [ -n "${{ github.event.inputs.target-branch }}" ]; then
            TARGET_BRANCH="${{ github.event.inputs.target-branch }}"
          fi
          bash .github/scripts/commit-github-pages.sh "docs" "$TARGET_BRANCH"
