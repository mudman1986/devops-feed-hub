name: DevOps Feed Hub

on:
  push:

  schedule:
    - cron: "0 */12 * * *"

  workflow_dispatch:
    inputs:
      target-branch:
        description: "Target branch for GitHub Pages content (default: github-pages)"
        required: false
        default: "github-pages"

permissions:
  contents: write

jobs:
  collect-feeds:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Collect RSS Feeds
        id: collect
        uses: ./actions/collect-rss-feeds
        with:
          hours: "720"
          config-path: ".github/rss-feeds.json"
          output-path: "rss-feeds-output.json"

      - name: Display collection stats
        if: always()
        env:
          TOTAL_ARTICLES: ${{ steps.collect.outputs.total-articles }}
          SUCCESSFUL_FEEDS: ${{ steps.collect.outputs.successful-feeds }}
          FAILED_FEEDS: ${{ steps.collect.outputs.failed-feeds }}
        run: |
          echo "## Collection Statistics"
          echo "- Total articles: $TOTAL_ARTICLES"
          echo "- Successful feeds: $SUCCESSFUL_FEEDS"
          echo "- Failed feeds: $FAILED_FEEDS"

      - name: Generate GitHub Pages content
        if: success()
        run: |
          # Create docs directory if it doesn't exist
          mkdir -p docs

          # Generate multi-page HTML (main index + individual feed pages)
          python3 actions/collect-rss-feeds/generate_summary.py \
            --input rss-feeds-output.json \
            --output-dir docs

          echo "✓ GitHub Pages content generated (multi-page)"

          # Generate RSS feeds (master + individual feeds)
          python3 actions/collect-rss-feeds/generate_rss.py \
            --input rss-feeds-output.json \
            --output-dir docs

          echo "✓ RSS feeds generated"

      - name: Format HTML files
        if: success()
        run: |
          npx prettier --write docs/*.html
          echo "✓ HTML files formatted with Prettier"

      - name: Commit and push GitHub Pages content
        if: success()
        env:
          TARGET_BRANCH_INPUT: ${{ github.event.inputs.target-branch }}
        run: |
          # Default to 'github-pages' branch, override with workflow_dispatch input if provided
          TARGET_BRANCH="github-pages"
          if [ -n "$TARGET_BRANCH_INPUT" ]; then
            TARGET_BRANCH="$TARGET_BRANCH_INPUT"
          fi
          bash .github/workflows/scripts/commit-github-pages.sh "docs" "$TARGET_BRANCH"
