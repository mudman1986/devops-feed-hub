name: RSS Feed Collector

on:
  # Run on push to any branch
  push:
    branches:
      - '**'
  
  # Schedule to run on weekdays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1-5'  # Monday-Friday at 9 AM UTC
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read

jobs:
  collect-rss-feeds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get last successful run time
        id: last-run
        run: |
          # Get the current date
          TODAY=$(date -u +%Y-%m-%d)
          
          # Try to get the last successful run time from this workflow
          LAST_RUN=$(gh run list \
            --workflow="rss-feed-collector.yml" \
            --status=success \
            --limit=1 \
            --json updatedAt \
            --jq '.[0].updatedAt' 2>/dev/null || echo "")
          
          if [ -n "$LAST_RUN" ]; then
            LAST_RUN_DATE=$(date -u -d "$LAST_RUN" +%Y-%m-%d)
            LAST_RUN_EPOCH=$(date -u -d "$LAST_RUN" +%s)
            NOW_EPOCH=$(date -u +%s)
            HOURS_SINCE=$((($NOW_EPOCH - $LAST_RUN_EPOCH) / 3600))
            
            # If last run was today, use 24 hours, otherwise use hours since last run
            if [ "$LAST_RUN_DATE" = "$TODAY" ]; then
              echo "hours=24" >> $GITHUB_OUTPUT
              echo "Last successful run was today, fetching articles from last 24 hours"
            else
              # Cap at 168 hours (1 week) to avoid too much data
              if [ $HOURS_SINCE -gt 168 ]; then
                HOURS_SINCE=168
              fi
              echo "hours=$HOURS_SINCE" >> $GITHUB_OUTPUT
              echo "Last successful run was $HOURS_SINCE hours ago, fetching articles since then"
            fi
          else
            # No previous successful run, default to 24 hours
            echo "hours=24" >> $GITHUB_OUTPUT
            echo "No previous successful run found, fetching articles from last 24 hours"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Fetch RSS feeds
        run: |
          python .github/scripts/fetch_rss_feeds.py \
            --config .github/rss-feeds.json \
            --hours ${{ steps.last-run.outputs.hours }} \
            --output rss-output.json \
            --markdown-output rss-output.md
      
      - name: Send to MS Teams
        if: ${{ secrets.MS_TEAMS_WEBHOOK_URL != '' }}
        run: |
          # Read the markdown content
          MARKDOWN_CONTENT=$(cat rss-output.md)
          
          # Create Teams adaptive card JSON
          cat > teams-message.json << 'EOF'
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "type": "AdaptiveCard",
                  "version": "1.4",
                  "body": [
                    {
                      "type": "TextBlock",
                      "text": "RSS Feed Updates",
                      "size": "Large",
                      "weight": "Bolder"
                    },
                    {
                      "type": "TextBlock",
                      "text": "New articles from your subscribed RSS feeds",
                      "wrap": true,
                      "spacing": "Small"
                    },
                    {
                      "type": "TextBlock",
                      "text": "MARKDOWN_PLACEHOLDER",
                      "wrap": true
                    }
                  ]
                }
              }
            ]
          }
          EOF
          
          # Escape the markdown content for JSON
          ESCAPED_MARKDOWN=$(echo "$MARKDOWN_CONTENT" | jq -Rs .)
          
          # Replace placeholder with actual markdown
          jq --argjson markdown "$ESCAPED_MARKDOWN" \
            '.attachments[0].content.body[2].text = $markdown' \
            teams-message.json > teams-message-final.json
          
          # Send to Teams
          curl -H "Content-Type: application/json" \
            -d @teams-message-final.json \
            "${{ secrets.MS_TEAMS_WEBHOOK_URL }}"
      
      - name: Display results summary
        if: always()
        run: |
          echo "## RSS Feed Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f rss-output.md ]; then
            cat rss-output.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No results generated" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rss-feed-results
          path: |
            rss-output.json
            rss-output.md
          retention-days: 7
