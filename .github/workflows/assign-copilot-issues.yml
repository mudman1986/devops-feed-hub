name: Assign Issues to Copilot

on:
  # Daily schedule for auto-assignment
  schedule:
    - cron: "0 9 * * *" # Daily at 9 AM UTC
    - cron: "0 9 * * 1" # Weekly on Monday at 9 AM UTC (for refactor)

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      mode:
        description: "Assignment mode"
        required: true
        default: "auto"
        type: choice
        options:
          - auto
          - refactor
      label:
        description: "Priority label (auto mode only)"
        required: false
        type: choice
        options:
          - ""
          - bug
          - documentation
          - enhancement
      force:
        description: "Force assignment even if copilot has an issue"
        required: false
        type: boolean
        default: false

  # Trigger when an issue is closed (with delay for grace period)
  issues:
    types: [closed]

permissions:
  contents: read
  issues: write

jobs:
  # Wait job to provide grace period when issue is closed
  wait-grace-period:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: Wait 5 minutes for manual assignment
        run: sleep 300

  assign-issue:
    runs-on: ubuntu-latest
    needs: [wait-grace-period]
    # Skip the wait job if not triggered by issue closure
    if: always() && (needs.wait-grace-period.result == 'success' || needs.wait-grace-period.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Determine assignment mode
        id: mode
        run: |
          # Determine mode based on trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            # Check if this is Monday (weekly refactor)
            if [ "$(date +%u)" = "1" ] && [ "${{ github.event.schedule }}" = "0 9 * * 1" ]; then
              MODE="refactor"
            else
              MODE="auto"
            fi
          else
            MODE="auto"
          fi

          echo "mode=${MODE}" >> "$GITHUB_OUTPUT"
          echo "Assignment mode: ${MODE}"

      - name: Assign Copilot to issue
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_PAT }}
          script: |
            const mode = '${{ steps.mode.outputs.mode }}';
            const labelOverride = '${{ inputs.label }}' || null;
            const force = '${{ inputs.force }}' === 'true';

            console.log(`Running in ${mode} mode, force=${force}, labelOverride=${labelOverride}`);

            // Step 1: Get repo ID, Copilot bot ID
            const repoInfo = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  id
                  suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                    nodes { login __typename ... on Bot { id } ... on User { id } }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const repoId = repoInfo.repository.id;
            const copilotBot = repoInfo.repository.suggestedActors.nodes.find(
              n => n.login === "copilot-swe-agent" && n.__typename === "Bot"
            );
            if (!copilotBot) {
              console.log("Actors found:");
              repoInfo.repository.suggestedActors.nodes.forEach(n => console.log(JSON.stringify(n)));
              throw new Error("Copilot bot agent not found in suggestedActors");
            }
            const copilotBotId = copilotBot.id;

            // Step 2: Check if Copilot is already assigned to an issue (unless force is true)
            if (!force) {
              const assignedIssues = await github.graphql(`
                query($owner: String!, $repo: String!) {
                  repository(owner: $owner, name: $repo) {
                    issues(first: 100, states: OPEN, filterBy: { assignee: "copilot-swe-agent" }) {
                      nodes {
                        number
                        title
                        url
                        labels(first: 10) {
                          nodes { name }
                        }
                      }
                    }
                  }
                }
              `, {
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              if (assignedIssues.repository.issues.nodes.length > 0) {
                console.log("Copilot is already assigned to the following issues:");
                assignedIssues.repository.issues.nodes.forEach(issue => {
                  console.log(`  - #${issue.number}: ${issue.title} (${issue.url})`);
                });
                console.log("Skipping assignment. Use force=true to override.");
                return;
              }
            }

            // Step 3: Handle different modes
            if (mode === 'refactor') {
              await createRefactorIssue();
            } else if (mode === 'auto') {
              await assignNextIssue(labelOverride);
            } else {
              throw new Error(`Unknown mode: ${mode}`);
            }

            /**
             * Create a weekly refactor issue
             */
            async function createRefactorIssue() {
              // Get refactor label ID
              const labelInfo = await github.graphql(`
                query($owner: String!, $repo: String!) {
                  repository(owner: $owner, name: $repo) {
                    label(name: "refactor") {
                      id
                    }
                  }
                }
              `, {
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              if (!labelInfo.repository.label) {
                throw new Error("Refactor label not found in repository.");
              }
              const refactorLabelId = labelInfo.repository.label.id;

              // Create and assign issue to Copilot
              const res = await github.graphql(`
                mutation($repositoryId: ID!, $title: String!, $body: String!, $assigneeIds: [ID!]) {
                  createIssue(
                    input: {
                      repositoryId: $repositoryId,
                      title: $title,
                      body: $body,
                      assigneeIds: $assigneeIds
                    }
                  ) {
                    issue {
                      id
                      url
                      title
                      assignees(first: 10) { nodes { login } }
                    }
                  }
                }
              `, {
                repositoryId: repoId,
                title: `Weekly Refactor - ${new Date().toISOString()}`,
                body: [
                  'Review the codebase and make improvements:',
                  '',
                  '- Fix failing tests (superlinter, ci, ui tests)',
                  '- Refactor duplicate code',
                  '- Address security vulnerabilities',
                  '- Improve code maintainability and performance',
                  '- Enhance UI accessibility',
                  '- Increase test coverage',
                  '',
                  '**Rules:**',
                  '- Assign tasks to all available specialized agents in the repository (e.g., UI/UX Specialist, Test Runner, Code Review, etc.)',
                  '- Make minimal surgical changes, run all linters/tests before completing.'
                ].join('\n'),
                assigneeIds: [copilotBotId]
              });

              console.log(`Created Copilot-assigned issue: ${res.createIssue.issue.url}`);

              // Add refactor label to the issue
              const issueId = res.createIssue.issue.id;
              try {
                await github.graphql(`
                  mutation($issueId: ID!, $labelIds: [ID!]!) {
                    addLabelsToLabelable(
                      input: {
                        labelableId: $issueId,
                        labelIds: $labelIds
                      }
                    ) {
                      labelable {
                        ... on Issue {
                          labels(first: 10) {
                            nodes {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                `, {
                  issueId,
                  labelIds: [refactorLabelId]
                });

                console.log(`Added 'refactor' label to issue`);
              } catch (error) {
                console.error(`Failed to add refactor label: ${error.message}`);
                console.error("Issue was created successfully but label could not be added.");
                // Don't throw - issue was created successfully
              }
            }

            /**
             * Assign Copilot to the next available issue based on priority
             */
            async function assignNextIssue(labelOverride) {
              // Define label priority
              const labelPriority = labelOverride ? [labelOverride] : ['bug', 'documentation', 'enhancement'];

              let issueToAssign = null;

              // Try to find an issue by priority
              for (const label of labelPriority) {
                console.log(`Searching for issues with label: ${label}`);
                
                const issues = await github.graphql(`
                  query($owner: String!, $repo: String!, $label: String!) {
                    repository(owner: $owner, name: $repo) {
                      issues(first: 50, states: OPEN, labels: [$label], orderBy: {field: CREATED_AT, direction: ASC}) {
                        nodes {
                          id
                          number
                          title
                          url
                          assignees(first: 10) {
                            nodes { login }
                          }
                          labels(first: 10) {
                            nodes { name }
                          }
                          trackedIssues(first: 1) {
                            totalCount
                          }
                        }
                      }
                    }
                  }
                `, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  label: label
                });

                // Find first unassigned issue without sub-issues and without refactor label
                for (const issue of issues.repository.issues.nodes) {
                  const hasSubIssues = issue.trackedIssues.totalCount > 0;
                  const isRefactorIssue = issue.labels.nodes.some(l => l.name === 'refactor');
                  const isAssigned = issue.assignees.nodes.length > 0;

                  console.log(`  Issue #${issue.number}: ${issue.title}`);
                  console.log(`    - Assigned: ${isAssigned}, SubIssues: ${hasSubIssues}, Refactor: ${isRefactorIssue}`);

                  if (!isAssigned && !hasSubIssues && !isRefactorIssue) {
                    issueToAssign = issue;
                    break;
                  }
                }

                if (issueToAssign) {
                  console.log(`Found issue to assign: #${issueToAssign.number}`);
                  break;
                }
              }

              // If no issue with priority labels, try other open issues
              if (!issueToAssign && !labelOverride) {
                console.log('Searching for any open unassigned issue...');
                
                const allIssues = await github.graphql(`
                  query($owner: String!, $repo: String!) {
                    repository(owner: $owner, name: $repo) {
                      issues(first: 100, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
                        nodes {
                          id
                          number
                          title
                          url
                          assignees(first: 10) {
                            nodes { login }
                          }
                          labels(first: 10) {
                            nodes { name }
                          }
                          trackedIssues(first: 1) {
                            totalCount
                          }
                        }
                      }
                    }
                  }
                `, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                });

                for (const issue of allIssues.repository.issues.nodes) {
                  const hasSubIssues = issue.trackedIssues.totalCount > 0;
                  const isRefactorIssue = issue.labels.nodes.some(l => l.name === 'refactor');
                  const isAssigned = issue.assignees.nodes.length > 0;
                  const hasPriorityLabel = issue.labels.nodes.some(l => labelPriority.includes(l.name));

                  // Skip issues already checked or priority issues (already checked above)
                  if (!isAssigned && !hasSubIssues && !isRefactorIssue && !hasPriorityLabel) {
                    issueToAssign = issue;
                    break;
                  }
                }
              }

              if (!issueToAssign) {
                console.log('No suitable issue found to assign to Copilot.');
                return;
              }

              // Assign the issue to Copilot
              console.log(`Assigning issue #${issueToAssign.number} to Copilot...`);
              
              await github.graphql(`
                mutation($issueId: ID!, $assigneeIds: [ID!]!) {
                  addAssigneesToAssignable(
                    input: {
                      assignableId: $issueId,
                      assigneeIds: $assigneeIds
                    }
                  ) {
                    assignable {
                      ... on Issue {
                        assignees(first: 10) {
                          nodes { login }
                        }
                      }
                    }
                  }
                }
              `, {
                issueId: issueToAssign.id,
                assigneeIds: [copilotBotId]
              });

              console.log(`âœ“ Successfully assigned issue #${issueToAssign.number} to Copilot`);
              console.log(`  Title: ${issueToAssign.title}`);
              console.log(`  URL: ${issueToAssign.url}`);
            }
