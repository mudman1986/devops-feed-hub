name: Assign Issues to Copilot

on:
  # Daily schedule to ensure Copilot always has work
  schedule:
    - cron: "0 10 * * *" # Daily at 10 AM UTC

  # Trigger when an issue is closed (with delay for grace period)
  issues:
    types: [closed]

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      mode:
        description: "Assignment mode"
        required: true
        default: "auto"
        type: choice
        options:
          - auto
          - refactor
      label:
        description: "Priority label (auto mode only, leave empty for default priority)"
        required: false
        type: string
        default: ""
      force:
        description: "Force assignment even if copilot has an issue"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Dry run mode - log what would be done without making changes"
        required: false
        type: boolean
        default: false
      allow_parent_issues:
        description: "Allow assigning issues that have sub-issues (open or closed)"
        required: false
        type: boolean
        default: false
      skip_labels:
        description: "Comma-separated list of labels to skip (e.g., 'no-ai,refining')"
        required: false
        type: string
        default: "no-ai,refining"
      refactor_threshold:
        description: "Number of closed issues to check for refactor label (default: 4, means 1 in 5 ratio)"
        required: false
        type: number
        default: 4

permissions:
  contents: read
  issues: write

concurrency:
  group: assign-copilot-issues
  cancel-in-progress: false

jobs:
  # Wait job to provide grace period when issue is closed
  # This job only runs on issue events; it will be skipped for schedule/dispatch events
  wait-grace-period:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: Wait 5 minutes for manual assignment
        run: sleep 300

  assign-issue:
    runs-on: ubuntu-latest
    needs: [wait-grace-period]
    # Run after wait job completes (for issue events) or immediately (for schedule/dispatch)
    # When wait-grace-period is skipped, needs.wait-grace-period.result will be 'skipped'
    if: |
      always() && (
        needs.wait-grace-period.result == 'success' ||
        needs.wait-grace-period.result == 'skipped'
      )
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Determine assignment mode
        id: mode
        run: |
          # Determine mode based on trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            # Daily schedule always uses auto mode (will create refactor if no issues available)
            MODE="auto"
            echo "Scheduled run - auto mode"
          else
            # Check last 4 closed issues to determine if we should create a refactor issue
            # If none of the last 4 closed issues have the refactor label, create one (1 in 5 ratio)
            echo "Checking last 4 closed issues for refactor label..."
            MODE="auto"  # Default to auto mode
          fi

          echo "mode=${MODE}" >> "$GITHUB_OUTPUT"
          echo "Assignment mode: ${MODE}"

      - name: Assign Copilot to issue
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_PAT }}
          script: |
            const mode = '${{ steps.mode.outputs.mode }}';
            const labelOverride = '${{ inputs.label }}' || null;
            const force = '${{ inputs.force }}' === 'true';
            const dryRun = '${{ inputs.dry_run }}' === 'true';
            const allowParentIssues = '${{ inputs.allow_parent_issues }}' === 'true';
            const skipLabelsRaw = '${{ inputs.skip_labels }}';
            const skipLabelsInput = skipLabelsRaw || 'no-ai,refining';
            const refactorThresholdRaw = '${{ inputs.refactor_threshold }}';
            const refactorThreshold = refactorThresholdRaw ? parseInt(refactorThresholdRaw, 10) : 4;

            // Parse skip labels from comma-separated string
            const skipLabels = skipLabelsInput
              .split(',')
              .map(label => label.trim())
              .filter(label => label.length > 0);

            console.log(
              `Running in ${mode} mode, ` +
              `force=${force}, ` +
              `labelOverride=${labelOverride}, ` +
              `dryRun=${dryRun}, ` +
              `allowParentIssues=${allowParentIssues}, ` +
              `refactorThreshold=${refactorThreshold}, ` +
              `skipLabels=${JSON.stringify(skipLabels)}`
            );

            // Load and execute the main workflow logic
            const path = require('path');
            const workflowPath = path.join(process.env.GITHUB_WORKSPACE, '.github/scripts/assign-copilot-workflow.js');
            const executeWorkflow = require(workflowPath);

            await executeWorkflow({
              github,
              context,
              mode,
              labelOverride,
              force,
              dryRun,
              allowParentIssues,
              skipLabels,
              refactorThreshold,
            });
